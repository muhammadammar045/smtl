name: Deploy to EC2 (Vite Frontend + JS Backend)

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: 📥 Checkout code
              uses: actions/checkout@v4

            - name: 🔐 Setup SSH key
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

            - name: 📄 Create .env.production for Vite from GitHub Secret
              working-directory: frontend
              run: |
                  echo "VITE_BACKEND_API_URL=${{ secrets.VITE_BACKEND_API_URL }}" > .env.production

            - name: ⚙️ Install and build frontend (Vite)
              working-directory: frontend
              run: |
                  npm ci
                  npm run build

            - name: 📤 Upload Vite frontend to EC2 (temp path)
              run: |
                  rsync -avz -e "ssh -i ~/.ssh/id_rsa" ./frontend/dist/ \
                    ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ubuntu/tmp-frontend/

            - name: 🔁 Move frontend to Nginx folder with sudo
              run: |
                  ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                    sudo rm -rf /var/www/frontend/*
                    sudo cp -r /home/ubuntu/tmp-frontend/* /var/www/frontend/
                    sudo chown -R www-data:www-data /var/www/frontend
                    echo "✅ Frontend moved to /var/www/frontend"
                  EOF

            - name: 📤 Upload backend code to EC2
              run: |
                  rsync -avz -e "ssh -i ~/.ssh/id_rsa" ./backend/ \
                    ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.EC2_PROJECT_DIR }}/backend/

            - name: 🚀 SSH into EC2 and restart backend
              run: |
                  ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                    cd ${{ secrets.EC2_PROJECT_DIR }}/backend
                    npm install
                    pm2 reload all || pm2 start src/index.js --name backend
                    echo "✅ Backend restarted successfully!"
                  EOF
